-- ============================================
--  SCHEMA NEUROSFERA
--  Sistema de Educação e Trabalho Imersivo em VR
-- ============================================

-- Dropar tabelas se existirem (ordem importante por causa das FKs)
DROP TABLE IF EXISTS USUARIO_DISTRITO;
DROP TABLE IF EXISTS USUARIOS;
DROP TABLE IF EXISTS DISTRITOS;

-- ============================================
--  TABELA: DISTRITOS
--  Descrição: Setores temáticos da cidade virtual
-- ============================================
CREATE TABLE DISTRITOS (
    ID_DISTRITO BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NM_DISTRITO VARCHAR(100) NOT NULL UNIQUE,
    AREA_DISTRITO VARCHAR(100) NOT NULL,
    DS_DISTRITO TEXT,
    ST_DISTRITO BOOLEAN NOT NULL DEFAULT TRUE,

    -- Constraints
    CONSTRAINT chk_area_distrito CHECK (
        AREA_DISTRITO IN (
            'Medicina', 'Engenharia', 'Design',
            'Inteligência Artificial', 'Sustentabilidade',
            'Negócios', 'Criatividade', 'Ciência de Dados',
            'Logística', 'Educação'
        )
    )
);

-- Criar índices para melhor performance
CREATE INDEX idx_distrito_area ON DISTRITOS(AREA_DISTRITO);
CREATE INDEX idx_distrito_status ON DISTRITOS(ST_DISTRITO);

-- ============================================
--  TABELA: USUARIOS
--  Descrição: Habitantes da Neurosfera
-- ============================================
CREATE TABLE USUARIOS (
    ID_USUARIO BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NM_USUARIO VARCHAR(100) NOT NULL,
    EMAIL_USUARIO VARCHAR(150) NOT NULL UNIQUE,
    SENHA_USUARIO VARCHAR(255) NOT NULL,
    TP_USUARIO VARCHAR(50) NOT NULL,
    DT_CADASTRO_USUARIO DATE NOT NULL,
    IDIOMA_USUARIO VARCHAR(10) NOT NULL DEFAULT 'PT-BR',
    ST_USUARIO BOOLEAN NOT NULL DEFAULT TRUE,

    -- Constraints (ATUALIZADAS PARA MAIÚSCULO)
    CONSTRAINT chk_tipo_usuario CHECK (
        TP_USUARIO IN (
            'APRENDIZ', 'INSTRUTOR', 'CRIADOR',
            'EMPRESA', 'ADMINISTRADOR'
        )
    ),
    CONSTRAINT chk_idioma_usuario CHECK (
        IDIOMA_USUARIO IN ('PT-BR', 'EN', 'ES', 'FR', 'DE')
    )
);

-- Criar índices
CREATE INDEX idx_usuario_email ON USUARIOS(EMAIL_USUARIO);
CREATE INDEX idx_usuario_tipo ON USUARIOS(TP_USUARIO);
CREATE INDEX idx_usuario_status ON USUARIOS(ST_USUARIO);

-- ============================================
--  TABELA: USUARIO_DISTRITO (Relacionamento N:N)
--  Descrição: Inscrições de usuários em distritos
-- ============================================
CREATE TABLE USUARIO_DISTRITO (
    ID_USUARIO BIGINT NOT NULL,
    ID_DISTRITO BIGINT NOT NULL,
    DT_INSCRICAO DATE NOT NULL DEFAULT CURRENT_DATE,

    PRIMARY KEY (ID_USUARIO, ID_DISTRITO),

    CONSTRAINT fk_usuario_distrito_usuario
        FOREIGN KEY (ID_USUARIO)
        REFERENCES USUARIOS(ID_USUARIO)
        ON DELETE CASCADE,

    CONSTRAINT fk_usuario_distrito_distrito
        FOREIGN KEY (ID_DISTRITO)
        REFERENCES DISTRITOS(ID_DISTRITO)
        ON DELETE CASCADE
);

-- Criar índices para relacionamento
CREATE INDEX idx_usuario_distrito_usuario ON USUARIO_DISTRITO(ID_USUARIO);
CREATE INDEX idx_usuario_distrito_distrito ON USUARIO_DISTRITO(ID_DISTRITO);

-- ============================================
--  COMENTÁRIOS NAS TABELAS (Sintaxe H2)
-- ============================================
-- Nota: H2 usa COMMENT ON COLUMN, não COMMENT ON TABLE diretamente
-- Comentários nas colunas principais:

COMMENT ON COLUMN DISTRITOS.NM_DISTRITO IS 'Nome do distrito temático';
COMMENT ON COLUMN DISTRITOS.AREA_DISTRITO IS 'Área de conhecimento do distrito';

COMMENT ON COLUMN USUARIOS.NM_USUARIO IS 'Nome completo do usuário';
COMMENT ON COLUMN USUARIOS.EMAIL_USUARIO IS 'Email único do usuário';
COMMENT ON COLUMN USUARIOS.TP_USUARIO IS 'Tipo/papel do usuário no sistema';

COMMENT ON COLUMN USUARIO_DISTRITO.DT_INSCRICAO IS 'Data de inscrição no distrito';